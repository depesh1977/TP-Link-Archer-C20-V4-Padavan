name: Build firmware LITE

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    container: registry.gitlab.com/hadzhioglu/padavan-ng
    defaults: { run: { shell: bash } }
    steps:
    - uses: actions/checkout@v4

    - name: Get variables
      run: |
        sed -i 's|\r$||g' variables 'build LITE.config'
        . <(cat variables build.config)
        PADAVAN_THEMES="${PADAVAN_THEMES[*]}"
        for v in "${!PADAVAN_@}" "${!CONFIG_@}"; do
          echo "$v=${!v}" >> $GITHUB_ENV
        done

    - name: Download sources and toolchain
      run: |
        git config --global --add safe.directory '*'
        git clone -b "$PADAVAN_BRANCH" "$PADAVAN_REPO"
        git -C padavan-ng checkout "$PADAVAN_COMMIT"
        wget -qO- "$PADAVAN_TOOLCHAIN_URL" | tar -C padavan-ng --zstd -xf -

    - name: Install themes
      run: |
        if [[ -n $PADAVAN_THEMES ]]; then
          git clone --depth 1 -b "$PADAVAN_THEMES_BRANCH" "$PADAVAN_THEMES_REPO" themes
          cp -r themes/common-theme themes/jquery.js padavan-ng/trunk/user/www/n56u_ribbon_fixed

          for theme in $PADAVAN_THEMES; do
            echo "Installing $theme theme"
            cp -r "themes/$theme-theme" padavan-ng/trunk/user/www/n56u_ribbon_fixed
          done
        fi

    - name: Run custom pre-build script
      run: '[[ -f pre-build.sh ]] && . pre-build.sh || :'

    - name: Build firmware
      run: |
        cp build.config padavan-ng/trunk/.config
        pushd padavan-ng/trunk
        ./clear_tree.sh
        ./build_firmware.sh
        popd

    - name: Run custom post-build script
      run: '[[ -f post-build.sh ]] && . post-build.sh || :'

    - name: Prepare artifacts
      run: |
        FW_FILE_NAME="$(find padavan-ng/trunk/images -type f -regextype posix-extended -iregex ".*\.(trx|bin)$" \
                        -printf "%T@\t%f\n" | sort -V | tail -1 | cut -f2)"
        cp "padavan-ng/trunk/images/$FW_FILE_NAME" .
        
        # Create 128KB empty file and recovery firmware
        dd if=/dev/zero of=128kempty.bin bs=128k count=1
        cat 128kempty.bin "$FW_FILE_NAME" > tp_recovery.bin
        
        # Download TFTP server
        wget -O tftpd64.464.zip https://bitbucket.org/phjounin/tftpd64/downloads/tftpd64.464.zip
        
        echo "FW_FILE_NAME=$FW_FILE_NAME" >> $GITHUB_ENV
        echo "BUILD_TIMESTAMP=$(date '+%Y.%m.%d_%H.%M.%S')" >> $GITHUB_ENV

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: padavan-ng_${{ env.CONFIG_VENDOR }}_${{ env.CONFIG_FIRMWARE_PRODUCT_ID }}_${{ env.BUILD_TIMESTAMP }}
        retention-days: 7
        path: |
          ${{ env.FW_FILE_NAME }}
          tp_recovery.bin
          tftpd64.464.zip

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: release-${{ env.BUILD_TIMESTAMP }}
        release_name: Padavan TP-Link Archer C5 V4 LITE (${{ env.BUILD_TIMESTAMP }})
        body: |
          üîß –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ—à–∏–≤–∫–∏:

          ‚ö° –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –∏ WiFi:
          ‚Ä¢ üöÄ –†–∞–∑–≥–æ–Ω –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ MT7620 –¥–æ 600MHz
          ‚Ä¢ üì° WiFi –¥—Ä–∞–π–≤–µ—Ä –≤–µ—Ä—Å–∏–∏ 2.7

          üåê –°–µ—Ç–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
          ‚Ä¢ ‚ú® –ü–æ–¥–¥–µ—Ä–∂–∫–∞ IPv6
          ‚Ä¢ üõ°Ô∏è XFRM (IPsec) –º–æ–¥—É–ª–∏ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è iptables
          ‚Ä¢ üéØ IPSet –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å IP-–∞–¥—Ä–µ—Å–∞–º–∏
          ‚Ä¢ üîÑ Shortcut Forward Engine –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
          
          üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ VPN:
          ‚Ä¢ üîê OpenVPN
          ‚Ä¢ üîë Dropbear SSH —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–æ–¥–æ–º
          ‚Ä¢ üõ°Ô∏è HTTPS –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ SSL
          ‚Ä¢ üîí EAP-TTLS –∏ EAP-PEAP –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
          ‚Ä¢ üåê HTTPS –¥–ª—è DDNS –∫–ª–∏–µ–Ω—Ç–∞
          ‚Ä¢ üîë OpenSSL —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Elliptic Curves
          ‚Ä¢ üõ†Ô∏è –£—Ç–∏–ª–∏—Ç–∞ openssl –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
          
          üåç –°–µ—Ä–≤–∏—Å—ã –∏ —É—Ç–∏–ª–∏—Ç—ã:
          ‚Ä¢ üì° xUPNPd IPTV –º–µ–¥–∏–∞—Å–µ—Ä–≤–µ—Ä
          ‚Ä¢ üîê DNSCrypt –ø—Ä–æ–∫—Å–∏
          ‚Ä¢ üåê WPAD –ø–æ–¥–¥–µ—Ä–∂–∫–∞
          ‚Ä¢ üíæ Compressed memory (ZRAM)
          ‚Ä¢ üîÑ EoIP —Ç—É–Ω–Ω–µ–ª–∏
          ‚Ä¢ üåê –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Curl
          ‚Ä¢ üõ°Ô∏è nfqws –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
          ‚Ä¢ üîß –ü–æ–¥–¥–µ—Ä–∂–∫–∞ LUA
          
          üåç –Ø–∑—ã–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:
          ‚Ä¢ üá∑üá∫ –†—É—Å—Å–∫–∏–π

          üåü –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—à–∏–≤–∫–∏:
          
          üì° –°–µ—Ç—å –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
          ‚Ä¢ üåç PPTP/L2TP –∫–ª–∏–µ–Ω—Ç
          ‚Ä¢ üîÑ DDNS —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π No-IP/DynDNS
          ‚Ä¢ üì± IPTV —Ä–µ–∂–∏–º
          
          üõ†Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã:
          ‚Ä¢ üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã
          ‚Ä¢ üïí –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á (Cron)
          ‚Ä¢ üíæ USB –Ω–∞–∫–æ–ø–∏—Ç–µ–ª–∏ (FAT/ext4)
          ‚Ä¢ üîç Samba —Å–µ—Ä–≤–µ—Ä
          
          üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
          ‚Ä¢ üõ°Ô∏è –ë–∞–∑–æ–≤—ã–π –º–µ–∂—Å–µ—Ç–µ–≤–æ–π —ç–∫—Ä–∞–Ω
          ‚Ä¢ üö´ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–µ–∫–ª–∞–º—ã
          ‚Ä¢ üë• –ì–æ—Å—Ç–µ–≤–∞—è —Å–µ—Ç—å
          
          üéÆ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
          ‚Ä¢ üå°Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
          ‚Ä¢ ‚ö° –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ USB –ø–æ—Ä—Ç–∞–º–∏
          ‚Ä¢ üì∂ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ—â–Ω–æ—Å—Ç–∏ Wi-Fi
          
          üì¶ –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã:
          ‚Ä¢ üì° Wireless tools
          ‚Ä¢ üîß –ë–∞–∑–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã —Å–∏—Å—Ç–µ–º—ã

          üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–æ—à–∏–≤–∫–∏
          
          üî∞ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:

              üõ°Ô∏è –û—Ç–∫–ª—é—á–∞–µ–º –±—Ä–∞–Ω–¥–º–∞—É—ç—Ä
              üîå –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–∞–±–µ–ª—å –≤ LAN –ø–æ—Ä—Ç
              ‚öôÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º IP: 192.168.0.66
              üíø –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º Tftpd64
              üìÅ –ö–æ–ø–∏—Ä—É–µ–º tp_recovery.bin –≤ –ø–∞–ø–∫—É TFTP


          üìù –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ—à–∏–≤–∫–∏:

              üîå –í—ã–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä
              ‚ö° –ó–∞–∂–∏–º–∞–µ–º Reset + –≤–∫–ª—é—á–∞–µ–º –ø–∏—Ç–∞–Ω–∏–µ
              ‚è≤Ô∏è –ñ–¥–µ–º 10-15 —Å–µ–∫—É–Ω–¥
              üîÑ –û—Ç–ø—É—Å–∫–∞–µ–º Reset
              üìä –°–ª–µ–¥–∏–º –∑–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–º –ø—Ä–æ—à–∏–≤–∫–∏ –≤ –æ–∫–Ω–µ Tftpd64
              ‚úÖ –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—à–∏–≤–∫–∏


          ‚ö†Ô∏è –í–∞–∂–Ω–æ: –ü–æ—Å–ª–µ –ø—Ä–æ—à–∏–≤–∫–∏ –≤–µ—Ä–Ω–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ IP


          üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏
          üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏:

              üì± –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Ä–æ—É—Ç–µ—Ä—É –ø–æ –∫–∞–±–µ–ª—é LAN (–Ω–µ –ø–æ Wi-Fi!)
              üåê –û—Ç–∫—Ä–æ–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å http://192.168.1.1
              ‚öôÔ∏è –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ -> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏
              üì¶ –°–∫–∞—á–∞–π—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é –ø—Ä–æ—à–∏–≤–∫–∏ —Å GitHub Releases
              üì§ –í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª .bin (–Ω–µ –∞—Ä—Ö–∏–≤!)
              ‚úÖ –ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ (3-5 –º–∏–Ω—É—Ç)


          üí° –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ü–µ—Ä–≤–∞—è –ø—Ä–æ—à–∏–≤–∫–∞ —á–µ—Ä–µ–∑ TFTP –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑. –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./${{ env.FW_FILE_NAME }}
        asset_name: ${{ env.FW_FILE_NAME }}
        asset_content_type: application/octet-stream

    - name: Upload Recovery Firmware Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./tp_recovery.bin
        asset_name: tp_recovery.bin
        asset_content_type: application/octet-stream

    - name: Upload TFTP Server Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./tftpd64.464.zip
        asset_name: tftpd64.464.zip
        asset_content_type: application/zip

    - name: Check firmware size
      run: |
        partitions=padavan-ng/trunk/configs/boards/$CONFIG_VENDOR/$CONFIG_FIRMWARE_PRODUCT_ID/partitions.config
        max_fw_size="$(awk '/Firmware/ { getline; getline; sub(",", ""); print strtonum($2); }' "$partitions")"
        fw_size="$(stat -c %s "$FW_FILE_NAME")"

        if ((fw_size > max_fw_size)); then
          fw_size_fmtd="$(numfmt --grouping "$fw_size") bytes"
          max_fw_size_fmtd="$(numfmt --grouping "$max_fw_size") bytes"
          echo "Firmware size ($fw_size_fmtd) exceeds max size ($max_fw_size_fmtd) for your target device"
          exit 1
        fi
