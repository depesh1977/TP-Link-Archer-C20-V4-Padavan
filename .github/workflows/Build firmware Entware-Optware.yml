name: Build firmware Entware-Optware

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 00:00 UTC
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    container: registry.gitlab.com/hadzhioglu/padavan-ng
    defaults: { run: { shell: bash } }
    steps:
    - uses: actions/checkout@v4

    - name: Get variables
      run: |
        sed -i 's|\r$||g' "variables" "build Entware-Optware.config"
        BUILDCONFIG="build Entware-Optware.config"
        cp "$BUILDCONFIG" build.config
        . build.config
        PADAVAN_THEMES="${PADAVAN_THEMES[*]}"
        for v in "${!PADAVAN_@}" "${!CONFIG_@}"; do
          echo "$v=${!v}" >> $GITHUB_ENV
        done

    - name: Download sources and toolchain
      run: |
        git config --global --add safe.directory '*'
        git clone -b "$PADAVAN_BRANCH" "$PADAVAN_REPO"
        git -C padavan-ng checkout "$PADAVAN_COMMIT"
        wget -qO- "$PADAVAN_TOOLCHAIN_URL" | tar -C padavan-ng --zstd -xf -

    - name: Install themes
      run: |
        if [[ -n $PADAVAN_THEMES ]]; then
          git clone --depth 1 -b "$PADAVAN_THEMES_BRANCH" "$PADAVAN_THEMES_REPO" themes
          cp -r themes/common-theme themes/jquery.js padavan-ng/trunk/user/www/n56u_ribbon_fixed

          for theme in $PADAVAN_THEMES; do
            echo "Installing $theme theme"
            cp -r "themes/$theme-theme" padavan-ng/trunk/user/www/n56u_ribbon_fixed
          done
        fi

    - name: Run custom pre-build script
      run: '[[ -f pre-build.sh ]] && . pre-build.sh || :'

    - name: Build firmware
      run: |
        cp build.config padavan-ng/trunk/.config
        pushd padavan-ng/trunk
        ./clear_tree.sh
        ./build_firmware.sh
        popd

    - name: Run custom post-build script
      run: '[[ -f post-build.sh ]] && . post-build.sh || :'

    - name: Prepare artifacts
      run: |
        FW_FILE_NAME="$(find padavan-ng/trunk/images -type f -regextype posix-extended -iregex ".*\.(trx|bin)$" \
                        -printf "%T@\t%f\n" | sort -V | tail -1 | cut -f2)"
        cp "padavan-ng/trunk/images/$FW_FILE_NAME" .
        
        # Create 128KB empty file and recovery firmware
        dd if=/dev/zero of=128kempty.bin bs=128k count=1
        cat 128kempty.bin "$FW_FILE_NAME" > tp_recovery.bin
        
        # Download TFTP server
        wget -O tftpd64.464.zip https://bitbucket.org/phjounin/tftpd64/downloads/tftpd64.464.zip
        
        echo "FW_FILE_NAME=$FW_FILE_NAME" >> $GITHUB_ENV
        echo "BUILD_TIMESTAMP=$(date '+%Y.%m.%d_%H.%M.%S')" >> $GITHUB_ENV

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: padavan-ng_${{ env.CONFIG_VENDOR }}_${{ env.CONFIG_FIRMWARE_PRODUCT_ID }}_${{ env.BUILD_TIMESTAMP }}
        retention-days: 7
        path: |
          ${{ env.FW_FILE_NAME }}
          tp_recovery.bin
          tftpd64.464.zip

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: release-${{ env.BUILD_TIMESTAMP }}
        release_name: Padavan TP-Link Archer C5 V4 Entware (${{ env.BUILD_TIMESTAMP }})
        body: |
          ## ðŸ’ ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ

          Ð•ÑÐ»Ð¸ Ð²Ð°Ð¼ Ð½Ñ€Ð°Ð²Ð¸Ñ‚ÑÑ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ°, Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ:

          - [ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ ÐºÐ¾Ñ„Ðµ](https://pay.cloudtips.ru/p/afb55f71)
          - [ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð½Ð° Boosty](https://boosty.to/danayer)

          ðŸ“‹ Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸
          
          ðŸ”° ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ°:

              ðŸ›¡ï¸ ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð±Ñ€Ð°Ð½Ð´Ð¼Ð°ÑƒÑÑ€
              ðŸ”Œ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÐºÐ°Ð±ÐµÐ»ÑŒ Ð² LAN Ð¿Ð¾Ñ€Ñ‚
              âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ IP: 192.168.0.66
              ðŸ’¿ Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Tftpd64
              ðŸ“ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ tp_recovery.bin Ð² Ð¿Ð°Ð¿ÐºÑƒ TFTP


          ðŸ“ ÐŸÑ€Ð¾Ñ†ÐµÑÑ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸:

              ðŸ”Œ Ð’Ñ‹ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ñ€Ð¾ÑƒÑ‚ÐµÑ€
              âš¡ Ð—Ð°Ð¶Ð¸Ð¼Ð°ÐµÐ¼ Reset + Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ðµ
              â²ï¸ Ð–Ð´ÐµÐ¼ 10-15 ÑÐµÐºÑƒÐ½Ð´
              ðŸ”„ ÐžÑ‚Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Reset
              ðŸ“Š Ð¡Ð»ÐµÐ´Ð¸Ð¼ Ð·Ð° Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð¼ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸ Ð² Ð¾ÐºÐ½Ðµ Tftpd64
              âœ… Ð–Ð´ÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸


          âš ï¸ Ð’Ð°Ð¶Ð½Ð¾: ÐŸÐ¾ÑÐ»Ðµ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸ Ð²ÐµÑ€Ð½Ð¸Ñ‚Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ IP


          ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸
          ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸:

              ðŸ“± ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÐµÑÑŒ Ðº Ñ€Ð¾ÑƒÑ‚ÐµÑ€Ñƒ Ð¿Ð¾ ÐºÐ°Ð±ÐµÐ»ÑŽ LAN (Ð½Ðµ Ð¿Ð¾ Wi-Fi!)
              ðŸŒ ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ http://192.168.1.1
              âš™ï¸ ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Ñ€Ð°Ð·Ð´ÐµÐ» ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ -> ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸
              ðŸ“¦ Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸ Ñ GitHub Releases
              ðŸ“¤ Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐºÐ°Ñ‡Ð°Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» .bin (Ð½Ðµ Ð°Ñ€Ñ…Ð¸Ð²!)
              âœ… ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ" Ð¸ Ð´Ð¾Ð¶Ð´Ð¸Ñ‚ÐµÑÑŒ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ (3-5 Ð¼Ð¸Ð½ÑƒÑ‚)


          ðŸ’¡ ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ðµ: ÐŸÐµÑ€Ð²Ð°Ñ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· TFTP Ð½ÑƒÐ¶Ð½Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð·. Ð’ÑÐµ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ.

          ## ðŸ“š Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Entware/Optware

          Entware â€” ÑÑ‚Ð¾ Ð¿ÐµÑ€ÐµÐ´Ð¾Ð²Ð¾Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹, Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÑŽÑ‰Ð¸Ð¹ Ð»ÐµÐ³ÐºÐ¾ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°Ñ‚ÑŒ Linux-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð² ÐºÐ¾Ð½ÑÐ¾Ð»Ð¸ Ñ€Ð¾ÑƒÑ‚ÐµÑ€Ð°. Ð’ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð¸Ðµ Ð¾Ñ‚ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐµÐ³Ð¾ Optware, Entware Ñ€ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ.

          ### ðŸ”§ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° USB-Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»Ñ
          1. ÐžÑ‚Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ€Ð°Ð·Ð´ÐµÐ» Ð½Ð° USB Ð² Ext2/3/4
          2. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð¿Ð°Ð¿ÐºÑƒ opt Ð² ÐºÐ¾Ñ€Ð½Ðµ:
          ```bash
          mkdir /media/Main/opt
          ejusb
          ```

          ### âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸
          - ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ: ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ USB > ÐžÐ±Ñ‰Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
          - Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ "Entware" Ð¸Ð»Ð¸ "Optware" Ð² "Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÐº Optware?"
          - ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ"

          ### ðŸ“¥ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
          ```bash
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
          opkg update

          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ð°ÐºÐµÑ‚Ð° (Ð¿Ñ€Ð¸Ð¼ÐµÑ€: mc)
          opkg install mc

          # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð°
          opkg remove mc

          # ÐŸÐ¾Ð¸ÑÐº Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
          opkg find "*game*"
          ```

          ### ðŸ”„ ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
          - Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ Ð² /opt/etc/init.d Ð·Ð°Ð¿ÑƒÑÐºÐ°ÑŽÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
          - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ start/stop
          - ÐœÐ¾Ð¶Ð½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ ÑÐ²Ð¾Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹

          ### ðŸ’¡ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸
          - /opt/share/www/custom - Ð´Ð»Ñ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð²ÐµÐ±-ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°
          - /opt/etc/profile - Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ SSH/Telnet ÑÐµÑÑÐ¸Ð¸
          - /opt/home/admin - Ð´Ð¾Ð¼Ð°ÑˆÐ½ÑÑ Ð¿Ð°Ð¿ÐºÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
          - /opt/bin/on_wps.sh - Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð½Ð°Ð¶Ð°Ñ‚Ð¸Ñ WPS
          - /opt/bin/on_hotplug_printer.sh - Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸Ð½Ñ‚ÐµÑ€Ð¾Ð²
          - ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° SWAP-Ñ„Ð°Ð¹Ð»Ð° (/opt/.swap)
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./${{ env.FW_FILE_NAME }}
        asset_name: ${{ env.FW_FILE_NAME }}
        asset_content_type: application/octet-stream

    - name: Upload Recovery Firmware Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./tp_recovery.bin
        asset_name: tp_recovery.bin
        asset_content_type: application/octet-stream

    - name: Upload TFTP Server Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./tftpd64.464.zip
        asset_name: tftpd64.464.zip
        asset_content_type: application/zip

    - name: Check firmware size
      run: |
        partitions=padavan-ng/trunk/configs/boards/$CONFIG_VENDOR/$CONFIG_FIRMWARE_PRODUCT_ID/partitions.config
        max_fw_size="$(awk '/Firmware/ { getline; getline; sub(",", ""); print strtonum($2); }' "$partitions")"
        fw_size="$(stat -c %s "$FW_FILE_NAME")"

        if ((fw_size > max_fw_size)); then
          fw_size_fmtd="$(numfmt --grouping "$fw_size") bytes"
          max_fw_size_fmtd="$(numfmt --grouping "$max_fw_size") bytes"
          echo "Firmware size ($fw_size_fmtd) exceeds max size ($max_fw_size_fmtd) for your target device"
          exit 1
        fi
